<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#f5f5f7">
  <title>ประวัติการทำรายการ</title>
  <?!= include('base'); ?>
</head>
<body>
  <div class="header">
    <h1>ประวัติ</h1>
    <p class="header-subtitle">รายการทั้งหมดในระบบ</p>
  </div>
  
  <div class="container">
    <div class="card">
      <div class="card-title">ตัวกรอง</div>
      <form id="filterForm" onsubmit="applyFilters(event)">
        <div class="form-group">
          <label>วันที่เริ่มต้น</label>
          <input type="date" id="startDate">
        </div>
        <div class="form-group">
          <label>วันที่สิ้นสุด</label>
          <input type="date" id="endDate">
        </div>
        <div class="form-group">
          <label>ประเภทรายการ</label>
          <select id="transactionType">
            <option value="">ทั้งหมด</option>
            <option value="WITHDRAW">เบิก</option>
            <option value="RECEIVE">รับเข้า</option>
            <option value="CREATE">สร้างใหม่</option>
            <option value="EDIT">แก้ไข</option>
            <option value="DELETE">ลบ</option>
          </select>
        </div>
        <div class="form-group">
          <label>ผู้ทำรายการ</label>
          <input type="text" id="userName" placeholder="ค้นหาชื่อ...">
        </div>
        <button type="submit" class="btn btn-primary btn-block">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
          </svg>
          ค้นหา
        </button>
      </form>
    </div>

    <div class="card">
      <div class="card-title">รายการ (<span id="logCount">0</span>)</div>
      <div id="logsContainer">
        <div class="skeleton-list-item" style="flex-direction: column; align-items: flex-start; gap: 10px;">
          <div style="width: 100%; display: flex; justify-content: space-between; align-items: center;">
            <div class="skeleton-text" style="width: 50px; height: 22px; border-radius: var(--radius-full);"></div>
            <div class="skeleton-text" style="width: 100px; height: 12px;"></div>
          </div>
          <div style="width: 100%;">
            <div class="skeleton-list-item-title" style="width: 70%;"></div>
            <div class="skeleton-list-item-subtitle" style="width: 90%;"></div>
            <div class="skeleton-list-item-subtitle" style="width: 40%; margin-top: 4px;"></div>
          </div>
        </div>
        <div class="skeleton-list-item" style="flex-direction: column; align-items: flex-start; gap: 10px;">
          <div style="width: 100%; display: flex; justify-content: space-between; align-items: center;">
            <div class="skeleton-text" style="width: 50px; height: 22px; border-radius: var(--radius-full);"></div>
            <div class="skeleton-text" style="width: 100px; height: 12px;"></div>
          </div>
          <div style="width: 100%;">
            <div class="skeleton-list-item-title" style="width: 60%;"></div>
            <div class="skeleton-list-item-subtitle" style="width: 85%;"></div>
            <div class="skeleton-list-item-subtitle" style="width: 35%; margin-top: 4px;"></div>
          </div>
        </div>
        <div class="skeleton-list-item" style="flex-direction: column; align-items: flex-start; gap: 10px;">
          <div style="width: 100%; display: flex; justify-content: space-between; align-items: center;">
            <div class="skeleton-text" style="width: 50px; height: 22px; border-radius: var(--radius-full);"></div>
            <div class="skeleton-text" style="width: 100px; height: 12px;"></div>
          </div>
          <div style="width: 100%;">
            <div class="skeleton-list-item-title" style="width: 65%;"></div>
            <div class="skeleton-list-item-subtitle" style="width: 80%;"></div>
            <div class="skeleton-list-item-subtitle" style="width: 45%; margin-top: 4px;"></div>
          </div>
        </div>
        <div class="skeleton-list-item" style="flex-direction: column; align-items: flex-start; gap: 10px;">
          <div style="width: 100%; display: flex; justify-content: space-between; align-items: center;">
            <div class="skeleton-text" style="width: 50px; height: 22px; border-radius: var(--radius-full);"></div>
            <div class="skeleton-text" style="width: 100px; height: 12px;"></div>
          </div>
          <div style="width: 100%;">
            <div class="skeleton-list-item-title" style="width: 55%;"></div>
            <div class="skeleton-list-item-subtitle" style="width: 75%;"></div>
            <div class="skeleton-list-item-subtitle" style="width: 50%; margin-top: 4px;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <div class="nav-item" onclick="navigateTo('https://liff.line.me/2008893142-t04JvNpe')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      <span>หน้าแรก</span>
    </div>
    <div class="nav-item" onclick="navigateTo('https://liff.line.me/2008893142-t04JvNpe#withdraw')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      <span>เบิก</span>
    </div>
    <div class="nav-item" onclick="navigateTo('https://liff.line.me/2008893142-t04JvNpe#receive')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      <span>รับเข้า</span>
    </div>
    <div class="nav-item" onclick="navigateTo('https://liff.line.me/2008893142-t04JvNpe#return')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>
      <span>คืน</span>
    </div>
    <div class="nav-item active" onclick="navigateTo('https://liff.line.me/2008893142-t04JvNpe#dashboard')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/></svg>
      <span>อื่นๆ</span>
    </div>
  </nav>
  
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    var baseUrl = 'https://script.google.com/macros/s/AKfycbx485xIyUla9r78h6rxgwbr0JHlCt4skYjsXdxwPgHwjjwshVqhYI9OOVWY9fjVpYT0/exec';
    var preloadedData = <?!= preloadedData ? preloadedData : 'null' ?>;
    
    document.addEventListener('DOMContentLoaded', function() {
      initLiff();
      setDefaultDates();
      if (preloadedData) { renderLogs(preloadedData); }
      else { loadLogs(); }
    });
    
    function initLiff() {
      var liffId = '<?= liffId ?>';
      if (liffId) { liff.init({ liffId: liffId }).catch(function(err) { console.log('LIFF init error:', err); }); }
    }
    
    function setDefaultDates() {
      var now = new Date();
      var bangkokOffset = 7 * 60;
      var localOffset = now.getTimezoneOffset();
      var bangkokTime = new Date(now.getTime() + (bangkokOffset + localOffset) * 60 * 1000);
      var today = bangkokTime;
      var oneMonthAgo = new Date(bangkokTime);
      oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
      document.getElementById('startDate').value = formatDateLocal(oneMonthAgo);
      document.getElementById('endDate').value = formatDateLocal(today);
    }
    
    function formatDateLocal(date) {
      return date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');
    }
    
    function formatDateTime(dateStr) {
      var date = new Date(dateStr);
      return date.toLocaleDateString('th-TH') + ' ' + date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
    }
    
    function applyFilters(e) { e.preventDefault(); loadLogs(); }
    
    function loadLogs() {
      var params = new URLSearchParams({
        action: 'getLogs',
        startDate: document.getElementById('startDate').value,
        endDate: document.getElementById('endDate').value,
        type: document.getElementById('transactionType').value,
        userName: document.getElementById('userName').value
      });
      fetch(baseUrl + '?' + params.toString())
        .then(function(res) { return res.json(); })
        .then(function(logs) { renderLogs(logs); })
        .catch(function(err) { console.error('Error loading logs:', err); });
    }
    
    function renderLogs(logs) {
      document.getElementById('logCount').textContent = logs.length;
      var container = document.getElementById('logsContainer');
      if (logs.length === 0) {
        container.innerHTML = '<div class="empty-state"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--text-tertiary)" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><div class="empty-state-text">ไม่พบรายการ</div></div>';
        return;
      }
      var html = '';
      logs.forEach(function(log) {
        var typeLabel = getTypeLabel(log.type);
        var typeClass = getTypeClass(log.type);
        html += '<div class="list-item" style="flex-direction: column; align-items: flex-start; gap: 10px;"><div style="width: 100%; display: flex; justify-content: space-between; align-items: center;"><span class="badge ' + typeClass + '">' + typeLabel + '</span><span style="font-size: 12px; color: var(--text-tertiary);">' + formatDateTime(log.timestamp) + '</span></div><div style="width: 100%;"><div class="list-item-title">' + log.productName + '</div><div class="list-item-subtitle">' + log.productCode + ' • จำนวน: ' + log.quantity + ' • ก่อน: ' + log.beforeQuantity + ' → หลัง: ' + log.afterQuantity + '</div><div class="list-item-subtitle">โดย: ' + log.userName + '</div></div></div>';
      });
      container.innerHTML = html;
    }
    
    function getTypeLabel(type) {
      var labels = { 'WITHDRAW': 'เบิก', 'RECEIVE': 'รับเข้า', 'CREATE': 'สร้าง', 'EDIT': 'แก้ไข', 'DELETE': 'ลบ' };
      return labels[type] || type;
    }
    
    function getTypeClass(type) {
      var classes = { 'WITHDRAW': 'badge-danger', 'RECEIVE': 'badge-success', 'CREATE': 'badge-success', 'EDIT': 'badge-warning', 'DELETE': 'badge-danger' };
      return classes[type] || '';
    }
  </script>
</body>
</html>
