<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#f5f5f7">
  <title>รายงาน</title>
  <?!= include('base'); ?>
  <style>
    .summary-card {
      background: var(--bg-elevated);
      border-radius: var(--radius-lg);
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 12px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border);
    }
    .summary-icon {
      width: 52px;
      height: 52px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .summary-icon svg {
      width: 26px;
      height: 26px;
      stroke-width: 1.5;
    }
    .summary-content {
      flex: 1;
    }
    .summary-value {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.02em;
    }
    .summary-label {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 2px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>รายงาน</h1>
    <p class="header-subtitle">สรุปการเคลื่อนไหววัสดุ</p>
  </div>
  
  <div class="container">
    <div class="card">
      <div class="card-title">ตัวกรอง</div>
      <form id="filterForm" onsubmit="applyFilters(event)">
        <div class="form-group">
          <label>วันที่เริ่มต้น</label>
          <input type="date" id="startDate">
        </div>
        <div class="form-group">
          <label>วันที่สิ้นสุด</label>
          <input type="date" id="endDate">
        </div>
        <div class="form-group">
          <label>ประเภทรายการ</label>
          <select id="transactionType">
            <option value="">ทั้งหมด</option>
            <option value="WITHDRAW">เบิก</option>
            <option value="RECEIVE">รับเข้า</option>
            <option value="CREATE">สร้างใหม่</option>
            <option value="EDIT">แก้ไข</option>
            <option value="DELETE">ลบ</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary btn-block">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
          </svg>
          ค้นหา
        </button>
        <button type="button" class="btn btn-secondary btn-block mt-2" onclick="exportToExcel()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          Export Excel
        </button>
      </form>
    </div>

    <div class="summary-card">
      <div class="summary-icon" style="background: var(--danger-light);">
        <svg viewBox="0 0 24 24" fill="none" stroke="var(--danger)">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="17 8 12 3 7 8"/>
          <line x1="12" y1="3" x2="12" y2="15"/>
        </svg>
      </div>
      <div class="summary-content">
        <div class="summary-value" id="totalWithdrawals" style="color: var(--danger);">0</div>
        <div class="summary-label">เบิกออก</div>
      </div>
    </div>
    
    <div class="summary-card">
      <div class="summary-icon" style="background: var(--success-light);">
        <svg viewBox="0 0 24 24" fill="none" stroke="var(--success)">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
      </div>
      <div class="summary-content">
        <div class="summary-value" id="totalReceipts" style="color: var(--success);">0</div>
        <div class="summary-label">รับเข้า</div>
      </div>
    </div>
    
    <div class="summary-card">
      <div class="summary-icon" style="background: var(--bg-tertiary);">
        <svg viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)">
          <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
          <polyline points="17 6 23 6 23 12"/>
        </svg>
      </div>
      <div class="summary-content">
        <div class="summary-value" id="netChange">0</div>
        <div class="summary-label">เปลี่ยนแปลงสุทธิ</div>
      </div>
    </div>
    
    <div class="card">
      <div class="card-title">รายการ (<span id="transactionCount">0</span>)</div>
      <div class="table-container">
        <table>
          <thead>
            <tr><th>วันที่</th><th>ประเภท</th><th>วัสดุ</th><th>จำนวน</th></tr>
          </thead>
          <tbody id="transactionsBody">
            <tr><td colspan="4" class="text-center">กำลังโหลด...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <div class="nav-item" onclick="navigateTo('https://liff.line.me/2008893142-t04JvNpe')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      <span>หน้าแรก</span>
    </div>
    <div class="nav-item" onclick="navigateTo('https://liff.line.me/2008893142-t04JvNpe#withdraw')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      <span>เบิก</span>
    </div>
    <div class="nav-item" onclick="navigateTo('https://liff.line.me/2008893142-t04JvNpe#receive')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      <span>รับเข้า</span>
    </div>
    <div class="nav-item" onclick="navigateTo('https://liff.line.me/2008893142-t04JvNpe#return')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>
      <span>คืน</span>
    </div>
    <div class="nav-item active" onclick="navigateTo('https://liff.line.me/2008893142-t04JvNpe#dashboard')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/></svg>
      <span>อื่นๆ</span>
    </div>
  </nav>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    var baseUrl = 'https://script.google.com/macros/s/AKfycbx485xIyUla9r78h6rxgwbr0JHlCt4skYjsXdxwPgHwjjwshVqhYI9OOVWY9fjVpYT0/exec';
    var preloadedData = <?!= preloadedData ? preloadedData : 'null' ?>;
    
    document.addEventListener('DOMContentLoaded', function() {
      initLiff();
      setDefaultDates();
      if (preloadedData && preloadedData.success) { renderReport(preloadedData.data); }
      else { loadReport(); }
    });
    
    function initLiff() {
      var liffId = '<?= liffId ?>';
      if (liffId) { liff.init({ liffId: liffId }).catch(function(err) { console.log('LIFF init error:', err); }); }
    }
    
    function setDefaultDates() {
      var now = new Date();
      var bangkokOffset = 7 * 60;
      var localOffset = now.getTimezoneOffset();
      var bangkokTime = new Date(now.getTime() + (bangkokOffset + localOffset) * 60 * 1000);
      var today = bangkokTime;
      var oneMonthAgo = new Date(bangkokTime);
      oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
      document.getElementById('startDate').value = formatDateLocal(oneMonthAgo);
      document.getElementById('endDate').value = formatDateLocal(today);
    }
    
    function formatDateLocal(date) {
      return date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');
    }
    
    function formatDateTime(dateStr) {
      var date = new Date(dateStr);
      return date.toLocaleDateString('th-TH') + ' ' + date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
    }
    
    function applyFilters(e) { e.preventDefault(); loadReport(); }
    
    function loadReport() {
      LoadingUI.show('กำลังโหลดรายงาน...');
      var params = new URLSearchParams({
        action: 'getReport',
        startDate: document.getElementById('startDate').value,
        endDate: document.getElementById('endDate').value,
        transactionType: document.getElementById('transactionType').value
      });
      fetch(baseUrl + '?' + params.toString())
        .then(function(res) { return res.json(); })
        .then(function(result) { 
          LoadingUI.hide();
          if (result.success) { renderReport(result.data); } 
        })
        .catch(function(err) { 
          LoadingUI.hide();
          console.error('Error loading report:', err); 
        });
    }
    
    function renderReport(data) {
      currentReportData = data;
      document.getElementById('totalWithdrawals').textContent = data.summary.totalWithdrawals.toLocaleString();
      document.getElementById('totalReceipts').textContent = data.summary.totalReceipts.toLocaleString();
      document.getElementById('netChange').textContent = (data.summary.netChange >= 0 ? '+' : '') + data.summary.netChange.toLocaleString();
      document.getElementById('transactionCount').textContent = data.summary.transactionCount;
      var netChangeEl = document.getElementById('netChange');
      netChangeEl.style.color = data.summary.netChange >= 0 ? 'var(--success)' : 'var(--danger)';
      
      var tbody = document.getElementById('transactionsBody');
      if (data.transactions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center">ไม่พบรายการ</td></tr>';
        return;
      }
      var html = '';
      data.transactions.forEach(function(t) {
        var typeLabel = getTypeLabel(t.type);
        var typeClass = getTypeClass(t.type);
        html += '<tr><td style="font-size: 12px;">' + formatDateTime(t.timestamp) + '</td><td><span class="badge ' + typeClass + '">' + typeLabel + '</span></td><td>' + t.productName + '</td><td>' + t.quantity + '</td></tr>';
      });
      tbody.innerHTML = html;
    }
    
    function getTypeLabel(type) {
      var labels = { 'WITHDRAW': 'เบิก', 'RECEIVE': 'รับเข้า', 'CREATE': 'สร้าง', 'EDIT': 'แก้ไข', 'DELETE': 'ลบ' };
      return labels[type] || type;
    }
    
    function getTypeClass(type) {
      var classes = { 'WITHDRAW': 'badge-danger', 'RECEIVE': 'badge-success', 'CREATE': 'badge-success', 'EDIT': 'badge-warning', 'DELETE': 'badge-danger' };
      return classes[type] || '';
    }
    
    var currentReportData = null;
    
    function exportToExcel() {
      if (!currentReportData || !currentReportData.transactions || currentReportData.transactions.length === 0) {
        alert('ไม่มีข้อมูลให้ Export');
        return;
      }
      
      var csv = '\uFEFF'; // BOM for Thai encoding
      csv += 'วันที่,ประเภท,รหัสวัสดุ,ชื่อวัสดุ,จำนวน,ก่อน,หลัง,ผู้ทำรายการ\n';
      
      currentReportData.transactions.forEach(function(t) {
        var date = new Date(t.timestamp).toLocaleString('th-TH');
        csv += '"' + date + '","' + getTypeLabel(t.type) + '","' + t.productCode + '","' + t.productName + '",' + t.quantity + ',' + (t.beforeQuantity || '') + ',' + (t.afterQuantity || '') + ',"' + (t.userName || '') + '"\n';
      });
      
      var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      var link = document.createElement('a');
      var url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', 'report_' + document.getElementById('startDate').value + '_' + document.getElementById('endDate').value + '.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  </script>
</body>
</html>
